#include <stdio.h>
#include <string.h>
// 循环移位
void rotate_left(int a[56], int n) {
  int tmp[2] = {a[0], a[1]};
  for (int i = 0; i < 56 - n; i++) {
    a[i] = a[i + n];
  }
  if (n == 1) {
    a[55] = a[27];
    a[27] = tmp[0];
  } else {
    a[55] = a[27];
    a[54] = a[26];
    a[27] = tmp[1];
    a[26] = tmp[0];
  }
}
// 密钥扩展
int des_key_schedule(int key[64], int rk[16][48]) {
  int tmp[56];
  const int pc1[56] = {57, 49, 41, 33, 25, 17, 9,  1,  58, 50, 42, 34, 26, 18,
                       10, 2,  59, 51, 43, 35, 27, 19, 11, 3,  60, 52, 44, 36,
                       63, 55, 47, 39, 31, 23, 15, 7,  62, 54, 46, 38, 30, 22,
                       14, 6,  61, 53, 45, 37, 29, 21, 13, 5,  28, 20, 12, 4};
  const int pc2[48] = {14, 17, 11, 24, 1,  5,  3,  28, 15, 6,  21, 10,
                       23, 19, 12, 4,  26, 8,  16, 7,  27, 20, 13, 2,
                       41, 52, 31, 37, 47, 55, 30, 40, 51, 45, 33, 48,
                       44, 49, 39, 56, 34, 53, 46, 42, 50, 36, 29, 32};
  // 置换
  int i;
  for (i = 0; i < 56; i++) {
    tmp[i] = key[pc1[i]-1];
  }
  // 循环移位
  for (i = 0; i < 16; i++) {
    // 1 2 9 16
    if (i == 0 || i == 1 || i == 8 || i == 15) {
      rotate_left(tmp, 1);
    }
    rotate_left(tmp, 2);
    for (int j = 0; j < 48; j++) {
      rk[i][j] = tmp[pc2[j]-1];
    }
  }

  return 0;
}
void fround(int r[32], int key[48]) {
  const int s1[64] = {14, 4,  13, 1, 2,  15, 11, 8,  3,  10, 6,  12, 5,
                      9,  0,  7,  0, 15, 7,  4,  14, 2,  13, 1,  10, 6,
                      12, 11, 9,  5, 3,  8,  4,  1,  14, 8,  13, 6,  2,
                      11, 15, 12, 9, 7,  3,  10, 5,  0,  15, 12, 8,  2,
                      4,  9,  1,  7, 5,  11, 3,  14, 10, 0,  6,  13};
  const int s2[64] = {15, 1,  8,  14, 6,  11, 3, 4,  9,  7,  2,  13, 12,
                      0,  5,  10, 3,  13, 4,  7, 15, 2,  8,  14, 12, 0,
                      1,  10, 6,  9,  11, 5,  0, 14, 7,  11, 10, 4,  13,
                      1,  5,  8,  12, 6,  9,  3, 2,  15, 13, 8,  10, 1,
                      3,  15, 4,  2,  11, 6,  7, 12, 0,  5,  14, 9};
  const int s3[64] = {10, 0,  9,  14, 6,  3,  15, 5,  1,  13, 12, 7,  11,
                      4,  2,  8,  13, 7,  0,  9,  3,  4,  6,  10, 2,  8,
                      5,  14, 12, 11, 15, 1,  13, 6,  4,  9,  8,  15, 3,
                      0,  11, 1,  2,  12, 5,  10, 14, 7,  1,  10, 13, 0,
                      6,  9,  8,  7,  4,  15, 14, 3,  11, 5,  2,  12};
  const int s4[64] = {7,  13, 14, 3,  0,  6,  9,  10, 1,  2, 8,  5,  11,
                      12, 4,  15, 13, 8,  11, 5,  6,  15, 0, 3,  4,  7,
                      2,  12, 1,  10, 14, 9,  10, 6,  9,  0, 12, 11, 7,
                      13, 15, 1,  3,  14, 5,  2,  8,  4,  3, 15, 0,  6,
                      10, 1,  13, 8,  9,  4,  5,  11, 12, 7, 2,  14};
  const int s5[64] = {2,  12, 4, 1,  7,  10, 11, 6, 8,  5,  3,  15, 13,
                      0,  14, 9, 14, 11, 2,  12, 4, 7,  13, 1,  5,  0,
                      15, 10, 3, 9,  8,  6,  4,  2, 1,  11, 10, 13, 7,
                      8,  15, 9, 12, 5,  6,  3,  0, 14, 11, 8,  12, 7,
                      1,  14, 2, 13, 6,  15, 0,  9, 10, 4,  5,  3};
  const int s6[64] = {12, 1,  10, 15, 9,  2,  6,  8,  0,  13, 3, 4, 14,
                      7,  5,  11, 10, 15, 4,  2,  7,  12, 9,  5, 6, 1,
                      13, 14, 0,  11, 3,  8,  9,  14, 15, 5,  2, 8, 12,
                      3,  7,  0,  4,  10, 1,  13, 11, 6,  4,  3, 2, 12,
                      9,  5,  15, 10, 11, 14, 1,  7,  6,  0,  8, 13};
  const int s7[64] = {4,  11, 2,  14, 15, 0,  8, 13, 3,  12, 9,  7,  5,
                      10, 6,  1,  13, 0,  11, 7, 4,  9,  1,  8,  12, 14,
                      2,  6,  5,  10, 3,  15, 1, 4,  11, 13, 12, 3,  7,
                      14, 10, 15, 6,  8,  0,  5, 9,  2,  6,  11, 13, 8,
                      1,  4,  10, 7,  9,  5,  0, 15, 14, 2,  3,  12};
  const int s8[64] = {13, 2,  8, 4,  6,  15, 11, 1,  10, 9, 3, 14, 5,
                      0,  12, 7, 1,  15, 13, 8,  10, 3,  7, 4, 12, 5,
                      6,  11, 0, 14, 9,  2,  7,  11, 4,  1, 9, 12, 14,
                      2,  0,  6, 10, 13, 15, 3,  5,  8,  2, 1, 14, 7,
                      4,  10, 8, 13, 15, 12, 9,  0,  3,  5, 6, 11};
  const int *sbox[8] = {s1, s2, s3, s4, s5, s6, s7, s8};
  const int ext[48] = {32, 1,  2,  3,  4,  5,  4,  5,  6,  7,  8,  9,
                       8,  9,  10, 11, 12, 13, 12, 13, 14, 15, 16, 17,
                       16, 17, 18, 19, 20, 21, 20, 21, 22, 23, 24, 25,
                       24, 25, 26, 27, 28, 29, 28, 29, 30, 31, 32, 1};
  const int p[32] = {16, 7, 20, 21, 29, 12, 28, 17, 1,  15, 23,
                     26, 5, 18, 31, 10, 2,  8,  24, 14, 32, 27,
                     3,  9, 19, 13, 30, 6,  22, 11, 4,  25};
  int tmp[48];
  int i;
  for (i = 0; i < 48; i++) {
    tmp[i] = r[ext[i]-1]; // 扩展
    tmp[i] ^= key[i];   // 异或
  }
  // 过S盒
  unsigned int res;
  int ftmp[32];
  for (i = 0; i < 8; i++) {
    // 计算位置
    unsigned char row = tmp[i * 6 + 0] * 2 + tmp[i * 6 + 5];
    unsigned char column = tmp[i * 6 + 1] * 8 + tmp[i * 6 + 2] * 4 +
                           tmp[i * 6 + 3] * 2 + tmp[i * 6 + 4];
    res = sbox[i][row * 16 + column];
    for (int j = 0; j < 4; j++) {
      ftmp[i * 4 + j] = (res >> (3 - j)) & 1;
    }
  }
  for (i = 0; i < 32; i++) {
    r[i] = ftmp[p[i]-1];
  }
}
int des_encrypt(int pt[64], int rk[16][48], int ct[64]) {
  //置换表
  const int IP[64] = {58, 50, 42, 34, 26, 18, 10, 2,  60, 52, 44, 36, 28,
                      20, 12, 4,  62, 54, 46, 38, 30, 22, 14, 6,  64, 56,
                      48, 40, 32, 24, 16, 8,  57, 49, 41, 33, 25, 17, 9,
                      1,  59, 51, 43, 35, 27, 19, 11, 3,  61, 53, 45, 37,
                      29, 21, 13, 5,  63, 55, 47, 39, 31, 23, 15, 7};
  int tmp[64];
  int *L = tmp, *R = tmp + 32;
  int i;
  int tmp_R[32]; // 用于计算的右半部分
  // 初始置换
  for (i = 0; i < 64; i++) {
    tmp[i] = pt[IP[i] - 1];
  }
  for (int k = 0; k < 32; k++) {
    tmp_R[k] = *(R + k);
  }
  // 进行15轮加密
  for (int j = 0; j < 15; j++) {
    fround(tmp_R, rk[i]);
    // 异或
    for (i = 0; i < 32; i++) {
      *(L + i) ^= tmp_R[i];
    }
    // 左右交换（这里使用指针交换）
    int *p = L;
    L = R;
    R = p;
    for (int k = 0; k < 32; k++) {
      tmp_R[k] = *(R + k);
    }
  }
  // 第16轮加密
  fround(tmp_R, rk[15]);
  for (i = 0; i < 32; i++) {
    *(L + i) ^= tmp_R[i];
  }
  // 初始逆置换
  for (i = 0; i < 64; i++) {
    ct[IP[i]] = i < 32 ? *(L + i) : *(R + i % 32);
  }
  return 0;
}
void test() {
  long long pla =
      0b1000000001000000001000000001000000001000000001000000001000000001;
  long long k =
      0b1000000000100000000100000100100000000000000000100000000001000000;
  int pt[64], ct[64], key[64], rk[16][48], rkd[16][48];
  for (int i = 0; i < 64; i++) {
    pt[i] = (pla >> (63 - i)) & 1;
    key[i] = (k >> (63 - i)) & 1;
  }
  des_key_schedule(key, rk);
  des_encrypt(pt, rk, ct);
  for (int i = 0; i < 64; i++) {
    printf("%d", ct[i]);
  }

  for (int i = 0; i < 16; i++) {
    memcpy(rkd[i], rk[15 - i], 48 * sizeof(int));
  }
  des_encrypt(ct, rkd, pt);
}
int main() {
  test();
  return 0;
}
